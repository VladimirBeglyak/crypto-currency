#name: Terraform + Nomad Deploy Java App
#
#on:
#  push:
#    branches: [ "master" ]
#
#jobs:
#  terraform-build-and-deploy:
#    runs-on: ubuntu-22.04
#
#    env:
#      NOMAD_ADDR: "http://127.0.0.1:4646"  # Nomad Dev Agent
#
#    steps:
#      # 1. Checkout repository
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      # 2. Setup Terraform
#      - name: Setup Terraform
#        uses: hashicorp/setup-terraform@v1
#        with:
#          terraform_version: "1.7.4"
#          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
#
#      # 3. Terraform Init
#      - name: Terraform Init
#        run: terraform init
#        working-directory: infra
#
#      # 4. Terraform Validate
#      - name: Terraform Validate
#        run: terraform validate
#        working-directory: infra
#
#      # 5. Terraform Plan
#      - name: Terraform Plan
#        run: terraform plan -no-color
#        working-directory: infra
#
#      # 6. Terraform Apply (only on push to master)
#      - name: Terraform Apply
#        if: github.ref == 'refs/heads/master'
#        run: terraform apply -auto-approve -no-color
#        working-directory: infra
#
#      # 7. Set up JDK 16 for Java build
#      - name: Set up JDK 16
#        uses: actions/setup-java@v4
#        with:
#          distribution: 'temurin'
#          java-version: '16'
#
#      # 8. Make gradlew executable
#      - name: Make gradlew executable
#        run: chmod +x gradlew
#
#      # 9. Build Spring Boot jar
#      - name: Build jar
#        run: ./gradlew bootJar
#
#      # 10. Log in to GitHub Container Registry
#      - name: Log in to GHCR
#        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
#
#      # 11. Build Docker image
#      - name: Build Docker image
#        run: |
#          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
#          IMAGE=ghcr.io/$REPO_LOWER/app:latest
#          docker build -t $IMAGE .
#          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
#
#      # 12. Push Docker image
#      - name: Push Docker image
#        run: docker push ${{ env.IMAGE }}
#
#      # 13. Install Nomad CLI
#      - name: Install Nomad CLI
#        run: |
#          TMP_DIR=$(mktemp -d)
#          curl -fsSL https://releases.hashicorp.com/nomad/1.7.4/nomad_1.7.4_linux_amd64.zip -o $TMP_DIR/nomad.zip
#          unzip -o $TMP_DIR/nomad.zip -d $TMP_DIR
#          sudo mv $TMP_DIR/nomad /usr/local/bin/
#
#      # 14. Start Nomad Dev Agent
#      - name: Start Nomad Dev Server
#        run: |
#          nohup nomad agent -dev -bind=127.0.0.1 > nomad.log 2>&1 &
#          sleep 5
#
#      # 15. Deploy Nomad Job
#      - name: Deploy job to Nomad
#        run: |
#          sed -i "s|IMAGE_REPLACE|${{ env.IMAGE }}|g" nomad/app.nomad
#          nomad job run nomad/app.nomad
