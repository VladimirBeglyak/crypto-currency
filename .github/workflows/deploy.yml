name: Deploy Java App to Nomad

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 16
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '16'

      - name: Give gradlew execute permission
        run: chmod +x gradlew

      - name: Build jar
        run: ./gradlew bootJar

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build Docker image
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE=ghcr.io/$REPO_LOWER/app:latest
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Push Docker image
        run: docker push ${{ env.IMAGE }}

      - name: Install Nomad CLI
        run: |
          # Создаем временную папку
          TMP_DIR=$(mktemp -d)
          curl -fsSL https://releases.hashicorp.com/nomad/1.7.4/nomad_1.7.4_linux_amd64.zip -o $TMP_DIR/nomad.zip
          unzip -o $TMP_DIR/nomad.zip -d $TMP_DIR
          sudo mv $TMP_DIR/nomad /usr/local/bin/

      - name: Start Nomad Dev Server
        run: |
          nomad agent -dev -bind=127.0.0.1 > nomad.log 2>&1 &
          sleep 5

      - name: Deploy job to Nomad
        run: |
          sed -i "s|IMAGE_REPLACE|${{ env.IMAGE }}|g" nomad/app.nomad
          nomad job run nomad/app.nomad
