name: Build and Deploy Java App with PostgreSQL

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    env:
      GITHUB_REPOSITORY: ${{ github.repository }}

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Set lowercase repository name for Docker
      - name: Set lowercase repository name
        run: echo "GITHUB_REPOSITORY_LOWER=$(echo ${GITHUB_REPOSITORY} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # 3. Set up JDK
      - name: Set up JDK 16
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '16'

      # 4. Make gradlew executable
      - name: Make gradlew executable
        run: chmod +x gradlew

      # 5. Build Spring Boot jar
      - name: Build jar
        run: ./gradlew bootJar

      # 6. Log in to GitHub Container Registry
      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # 7. Build Docker image
      - name: Build Docker image
        run: |
          IMAGE=ghcr.io/${GITHUB_REPOSITORY_LOWER}/app:latest
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # 8. Push Docker image
      - name: Push Docker image
        run: docker push ${{ env.IMAGE }}

      # 9. Install Docker Compose
      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version

      # 10. Run Docker Compose
      - name: Run Docker Compose
        run: |
          docker-compose down -v || true
          docker-compose up -d --build

      # 11. List running containers
      - name: List Docker containers
        run: docker ps
